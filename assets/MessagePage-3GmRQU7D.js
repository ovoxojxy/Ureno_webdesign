import{l as k,f as A,r as x,U as q,q as I,s as F,n as T,o as N,A as B,j as e,h as V,v as E,C as U,D as G,E as z,G as O,z as D,y as K}from"./index-BI0t34Mn.js";import"https://cdn.skypack.dev/gsap@3.12.0";import"https://cdn.skypack.dev/color";function H(){const{state:a,dispatch:u}=k(),{currentUser:r}=A(),{profile:i}=x.useContext(q),[p,v]=x.useState({}),[g,m]=x.useState({}),b=(i==null?void 0:i.role)==="contractor"?"/contractor-dashboard":"/ProfileDashboard";x.useEffect(()=>{v({})},[r]),x.useEffect(()=>{if(!a.conversations||a.conversations.length===0)return;(async()=>{const c={},h=a.conversations.map(async n=>{var d;const t=(d=n.participants)==null?void 0:d.find(l=>l!==r.uid);if(!(!t||g[t]))try{const l=E(N,"users",t),f=await U(l);if(f.exists()){const o=f.data();c[t]=o.displayName||`${o.firstName||"Unkown"} ${o.lastName||""}`.trim()}else c[t]="Unkown User"}catch(l){console.error(`Error fetching user ${t}:`,l),c[t]="Error Loading User"}});await Promise.all(h),m(n=>({...n,...c}))})()},[a.conversations,g]),x.useEffect(()=>{if(!a.conversations||a.conversations.length===0)return;(async()=>{const c={},h=a.conversations.map(async n=>{if(!(!n.projectId||p[n.projectId]))try{const t=E(N,"projects",n.projectId),d=await U(t);if(d.exists()){const l=d.data();c[n.projectId]={title:l.title||"Untitled Project",status:l.status||"Unknown Status"}}else c[n.projectId]="Unknown Project"}catch(t){console.error(`Error fetching project ${n.projectId}:`,t),c[n.projectId]="Error Loading Project"}});await Promise.all(h),v(n=>({...n,...c}))})()},[a.conversations,p]),x.useEffect(()=>{if(!r){console.log("No current user found — exiting useEffect.");return}console.log("Current user UID:",r.uid);const s=I(T(N,"conversations"),F("participants","array-contains",r.uid)),c=B(s,h=>{console.log("onSnapshot triggered");const n=[];h.forEach(t=>{n.push({id:t.id,...t.data()})}),n.sort((t,d)=>{var o,j,S,P,M,R;const l=((S=(j=(o=t.lastMessage)==null?void 0:o.timestamp)==null?void 0:j.toMillis)==null?void 0:S.call(j))||0;return(((R=(M=(P=d.lastMessage)==null?void 0:P.timestamp)==null?void 0:M.toMillis)==null?void 0:R.call(M))||0)-l}),console.log("Fetched conversations:",n),u({type:"SET_CONVERSATIONS",payload:n})});return()=>c()},[r,u]);const C=s=>{console.log(`Selecting conversation: ${s}, current selection: ${a.selectedConversation}`),u({type:"SELECT_CONVERSATION",payload:s})},w=a.conversations,y=a.selectedConversation&&!w.some(s=>s.id===a.selectedConversation)?{id:a.selectedConversation,projectId:"Selected Conversation"}:null;return e.jsxs("div",{className:"conversation-list",children:[e.jsxs("div",{className:"flex items-center gap-3 ",children:[e.jsx(V,{to:b,className:"text-blue-500 text-3xl font-bold hover:scale-110 hover:text-blue-700 transition-all duration-200 flex items-center justify-center",children:"<"}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"})]}),w.length===0&&!y?e.jsx("p",{children:"No conversations yet."}):e.jsxs("ul",{className:"space-y-4",children:[w.map(s=>{var t,d,l,f,o,j,S,P,M,R,$,L;const c=((l=(d=(t=s.lastReadBy)==null?void 0:t[r.uid])==null?void 0:d.toMillis)==null?void 0:l.call(d))||0,n=(((j=(o=(f=s.lastMessage)==null?void 0:f.timestamp)==null?void 0:o.toMillis)==null?void 0:j.call(o))||0)>c;return e.jsxs("li",{onClick:()=>C(s.id),className:`cursor-pointer p-3 rounded-md ${a.selectedConversation===s.id?"bg-blue-100 border-2 border-blue-500":"bg-gray-100"} ${n?"font-bold text-blue-800":"text-gray-700"}`,children:[e.jsx("div",{className:"font-medium text-gray-800",children:g[(S=s.participants)==null?void 0:S.find(_=>_!==r.uid)]||"loading..."}),e.jsxs("div",{children:["Project: ",s.projectTitle||((P=p[s.projectId])==null?void 0:P.title)||"Loading...",e.jsx("span",{className:`ml-2 text-xs px-2 py-1 rounded-full inline-block w-fit ${((R=(M=p[s.projectId])==null?void 0:M.status)==null?void 0:R.toLowerCase())==="in progress"?"bg-green-200 text-green-800":"bg-yellow-200 text-yellow-800"}`,children:(($=p[s.projectId])==null?void 0:$.status)||"Unknown Status"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[(L=s.lastMessage)!=null&&L.text?`${s.lastMessage.text.slice(0,30)}...`:"No messages yet",n&&e.jsx("span",{className:"text-blue-500 ml-2",children:"•"})]})]},s.id)}),y&&e.jsxs("li",{onClick:()=>C(y.id),className:"cursor-pointer p-3 rounded-md bg-blue-100 border-2 border-blue-500",children:[e.jsxs("div",{className:"font-semibold",children:["Project: ",y.projectTitle||p[y.projectId]||"Loading..."]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Currently selected conversation"})]},y.id)]})]})}function J({userId:a,isOpen:u,onClose:r}){const[i,p]=x.useState(null);return x.useEffect(()=>{if(!a||!u)return;(async()=>{try{const g=E(N,"users",a),m=await U(g);m.exists()?p(m.data()):p({displayName:"Unknown",role:"N/A"})}catch(g){console.error("Failed to fetch user: ",g)}})()},[a,u]),u?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg w-96",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"User Profile"}),i?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",i.displayName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Role:"})," ",i.role]}),(i==null?void 0:i.role)==="contractor"&&e.jsx("div",{className:"mt-2",children:e.jsx(G,{value:i.rating||0,readOnly:!0})})]}):e.jsx("p",{children:"Loading..."}),e.jsx("button",{onClick:r,className:"mt-4 bg-blue-500 text-white px-4 py-2 rounded",children:"Close"})]})}):null}function Q(){const{state:a,dispatch:u}=k(),{currentUser:r}=A(),{selectedConversation:i}=a,p=x.useRef(null),[v,g]=x.useState({}),[m,b]=x.useState(null),[C,w]=x.useState(!1),y=()=>{var s;(s=p.current)==null||s.scrollIntoView({behavior:"smooth"})};return x.useEffect(()=>{y()},[a.messages]),x.useEffect(()=>{if(!i)return;(async()=>{try{if(!(r!=null&&r.uid)||!i)return;const t=E(N,"conversations",i),d=await U(t);if(!d.exists()){console.warn("Conversation document not found.");return}const l=d.data(),f=(l==null?void 0:l.participants)||[];if(!Array.isArray(f)||f.length!==2){console.warn("Unexpected participants format:",f);return}await O(E(N,"conversations",i),{[`lastReadBy.${r.uid}`]:D()});const o=f.find(S=>S!==r.uid);if(!o)return;const j=await U(E(N,"users",o));j.exists()&&b(j.data())}catch(t){console.error("Error fetching other participant info:",t)}})();const c=T(N,"conversations",i,"messages"),h=I(c,z("timestamp","asc")),n=B(h,async t=>{const d=t.docs.map(o=>({id:o.id,...o.data()}));u({type:"SET_MESSAGES",payload:d});const l=[...new Set(d.map(o=>o.senderId))],f={...v};for(const o of l)if(o&&!f[o])try{const j=await U(E(N,"users",o));if(j.exists()){const S=j.data();f[o]=S}else f[o]={firstName:"Unknown",role:"User"}}catch{f[o]={firstName:"Unknown",role:"User"}}g(f)});return()=>n()},[i,u,r==null?void 0:r.uid]),i?e.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[70vh]",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-bold",children:["Chat with ",(m==null?void 0:m.displayName)||"Loading..."]}),e.jsx("button",{onClick:()=>w(!0),className:"text-blue-500 hover:underline",children:"View Profile"})]}),m&&e.jsx(J,{userId:m.uid,isOpen:C,onClose:()=>w(!1)}),a.messages.length===0?e.jsx("div",{className:"text-center text-gray-500",children:"No messages in this conversation yet"}):[...a.messages].sort((s,c)=>{var t,d,l,f;const h=((d=(t=s.timestamp)==null?void 0:t.toMillis)==null?void 0:d.call(t))||(s.timestamp instanceof Date?s.timestamp.getTime():0),n=((f=(l=c.timestamp)==null?void 0:l.toMillis)==null?void 0:f.call(l))||(c.timestamp instanceof Date?c.timestamp.getTime():0);return h-n}).map(s=>{var h,n,t;const c=s.senderId===(r==null?void 0:r.uid);return e.jsxs("div",{className:`flex flex-col ${c?"items-end":"items-start"}`,children:[!c&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("img",{src:(m==null?void 0:m.photoURL)||"/src/assets/images/default_pfp.png",alt:"sender",className:"w-6 h-6 rounded-full"}),e.jsx("div",{className:"text-xs text-gray-500",children:!c&&m?`${m.firstName||m.displayName||m.name||"Unknown"} • ${m.role||"User"}`:"Unknown sender • User"})]}),e.jsxs("div",{className:`p-2 rounded-md max-w-xs ${c?"bg-blue-500 text-white":"bg-gray-200"}`,children:[e.jsx("div",{className:"text-sm",children:s.text}),e.jsx("div",{className:`text-xs ${c?"text-blue-100":"text-gray-500"} text-right`,children:s.timestamp instanceof Date?s.timestamp.toLocaleString():((t=(n=(h=s.timestamp)==null?void 0:h.toDate)==null?void 0:n.call(h))==null?void 0:t.toLocaleString())||""})]})]},s.id)}),e.jsx("div",{ref:p})]}):e.jsx("div",{className:"p-4",children:"No Conversation Selected"})}async function W(a,u,r,i=null){if(!a||!u||!r){console.error("Missing required parameters for sendMessage");return}try{const p=T(N,"conversations",a,"messages");await K(p,{senderId:u,text:r,timestamp:D()});const v={text:r,senderId:u,timestamp:D()},g={text:r,senderId:u,timestamp:new Date};return await O(E(N,"conversations",a),{lastMessage:v,updatedAt:D()}),i&&(i({type:"ADD_MESSAGE",payload:{id:Date.now().toString(),senderId:u,text:r,timestamp:new Date}}),i({type:"UPDATE_LAST_MESSAGE",payload:{conversationId:a,lastMessage:g}})),!0}catch(p){return console.error("Error sending message:",p),!1}}function X(){const[a,u]=x.useState(""),r=x.useRef(null),{state:i,dispatch:p}=k(),{currentUser:v}=A(),{selectedConversation:g}=i,m=async b=>{var w;if(b.preventDefault(),!a.trim())return;const C=a.trim();u("");try{await W(g,v.uid,C,p)?console.log("Message sent successfully"):console.error("Failed to send message"),(w=r.current)==null||w.focus()}catch(y){console.error("Error sending message:",y)}};return g?e.jsxs("form",{onSubmit:m,className:"flex items-center p-4 border-t",children:[e.jsx("input",{ref:r,type:"text",placeholder:"Type a message...",value:a,onChange:b=>u(b.target.value),className:"flex-1 p-2 border rounded-md",onKeyDown:b=>{b.key==="Escape"&&(u(""),b.target.blur())}}),e.jsx("button",{type:"submit",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Send"})]}):null}function se(){return e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[e.jsx("aside",{className:"w-1/3 border-r overflow-y-auto",children:e.jsx(H,{})}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(Q,{})}),e.jsx(X,{})]})]})}export{se as default};
