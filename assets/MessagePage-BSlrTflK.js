import{b as y,h as j,r as x,U as A,q as w,w as R,e as N,f as v,o as D,j as s,L,n as $,m as B,s as b,p as F,i as P}from"./index-hEPJqI76.js";function _(){const{state:a,dispatch:r}=y(),{currentUser:t}=j(),{profile:i}=x.useContext(A),m=(i==null?void 0:i.role)==="contractor"?"/contractor-dashboard":"/ProfileDashboard";x.useEffect(()=>{if(!t){console.log("No current user found â€” exiting useEffect.");return}console.log("Current user UID:",t.uid);const e=w(N(v,"conversations"),R("participants","array-contains",t.uid)),c=D(e,l=>{console.log("onSnapshot triggered");const d=[];l.forEach(u=>{d.push({id:u.id,...u.data()})}),d.sort((u,p)=>{var S,f,C,E,h,M;const T=((C=(f=(S=u.lastMessage)==null?void 0:S.timestamp)==null?void 0:f.toMillis)==null?void 0:C.call(f))||0;return(((M=(h=(E=p.lastMessage)==null?void 0:E.timestamp)==null?void 0:h.toMillis)==null?void 0:M.call(h))||0)-T}),console.log("Fetched conversations:",d),r({type:"SET_CONVERSATIONS",payload:d})});return()=>c()},[t,r]),console.log("Conversations in state:",a.conversations);const g=e=>{console.log(`Selecting conversation: ${e}, current selection: ${a.selectedConversation}`),r({type:"SELECT_CONVERSATION",payload:e})},o=a.conversations,n=a.selectedConversation&&!o.some(e=>e.id===a.selectedConversation)?{id:a.selectedConversation,projectId:"Selected Conversation"}:null;return console.log("Selected conversation:",a.selectedConversation),console.log("Visible conversations:",o.map(e=>e.id)),s.jsxs("div",{className:"conversation-list",children:[s.jsxs("div",{className:"flex items-center gap-3 ",children:[s.jsx(L,{to:m,className:"text-blue-500 text-3xl font-bold hover:scale-110 hover:text-blue-700 transition-all duration-200 flex items-center justify-center",children:"<"}),s.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"})]}),o.length===0&&!n?s.jsx("p",{children:"No conversations yet."}):s.jsxs("ul",{className:"space-y-4",children:[o.map(e=>{var c;return s.jsxs("li",{onClick:()=>g(e.id),className:`cursor-pointer p-3 rounded-md ${a.selectedConversation===e.id?"bg-blue-100 border-2 border-blue-500":"bg-gray-100"}`,children:[s.jsxs("div",{className:"font-semibold",children:["Project: ",e.projectId]}),s.jsx("div",{className:"text-sm text-gray-600",children:(c=e.lastMessage)!=null&&c.text?`${e.lastMessage.text.slice(0,30)}...`:"No messages yet"})]},e.id)}),n&&s.jsxs("li",{onClick:()=>g(n.id),className:"cursor-pointer p-3 rounded-md bg-blue-100 border-2 border-blue-500",children:[s.jsxs("div",{className:"font-semibold",children:["Project: ",n.projectId]}),s.jsx("div",{className:"text-sm text-gray-600",children:"Currently selected conversation"})]},n.id)]})]})}function k(){const{state:a,dispatch:r}=y(),{currentUser:t}=j(),{selectedConversation:i}=a,m=x.useRef(null),g=()=>{var o;(o=m.current)==null||o.scrollIntoView({behavior:"smooth"})};return x.useEffect(()=>{g()},[a.messages]),x.useEffect(()=>{if(!i)return;console.log("Loading messages for conversation:",i),console.log("Current user UID:",t==null?void 0:t.uid);const o=N(v,"conversations",i,"messages"),n=w(o,$("timestamp","asc")),e=D(n,c=>{const l=c.docs.map(d=>({id:d.id,...d.data()}));console.log("Fetched messages:",l),r({type:"SET_MESSAGES",payload:l})});return()=>e()},[i,r,t==null?void 0:t.uid]),i?(console.log("Rendering messages with currentUser:",t==null?void 0:t.uid),s.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[70vh]",children:[a.messages.length===0?s.jsx("div",{className:"text-center text-gray-500",children:"No messages in this conversation yet"}):[...a.messages].sort((o,n)=>{var l,d,u,p;const e=((d=(l=o.timestamp)==null?void 0:l.toMillis)==null?void 0:d.call(l))||(o.timestamp instanceof Date?o.timestamp.getTime():0),c=((p=(u=n.timestamp)==null?void 0:u.toMillis)==null?void 0:p.call(u))||(n.timestamp instanceof Date?n.timestamp.getTime():0);return e-c}).map(o=>{var e,c,l;const n=o.senderId===(t==null?void 0:t.uid);return s.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`p-2 rounded-md max-w-xs ${n?"bg-blue-500 text-white":"bg-gray-200"}`,children:[s.jsx("div",{className:"text-sm",children:o.text}),s.jsx("div",{className:`text-xs ${n?"text-blue-100":"text-gray-500"} text-right`,children:o.timestamp instanceof Date?o.timestamp.toLocaleString():((l=(c=(e=o.timestamp)==null?void 0:e.toDate)==null?void 0:c.call(e))==null?void 0:l.toLocaleString())||""})]})},o.id)}),s.jsx("div",{ref:m})]})):s.jsx("div",{className:"p-4",children:"No Conversation Selected"})}async function q(a,r,t,i=null){if(!a||!r||!t){console.error("Missing required parameters for sendMessage");return}try{const m=N(v,"conversations",a,"messages");await B(m,{senderId:r,text:t,timestamp:b()});const g={text:t,senderId:r,timestamp:b()},o={text:t,senderId:r,timestamp:new Date};return await F(P(v,"conversations",a),{lastMessage:g,updatedAt:b()}),i&&(i({type:"ADD_MESSAGE",payload:{id:Date.now().toString(),senderId:r,text:t,timestamp:new Date}}),i({type:"UPDATE_LAST_MESSAGE",payload:{conversationId:a,lastMessage:o}})),!0}catch(m){return console.error("Error sending message:",m),!1}}function V(){const[a,r]=x.useState(""),t=x.useRef(null),{state:i,dispatch:m}=y(),{currentUser:g}=j(),{selectedConversation:o}=i,n=async e=>{var l;if(e.preventDefault(),!a.trim())return;const c=a.trim();r("");try{await q(o,g.uid,c,m)?console.log("Message sent successfully"):console.error("Failed to send message"),(l=t.current)==null||l.focus()}catch(d){console.error("Error sending message:",d)}};return o?s.jsxs("form",{onSubmit:n,className:"flex items-center p-4 border-t",children:[s.jsx("input",{ref:t,type:"text",placeholder:"Type a message...",value:a,onChange:e=>r(e.target.value),className:"flex-1 p-2 border rounded-md",onKeyDown:e=>{e.key==="Escape"&&(r(""),e.target.blur())}}),s.jsx("button",{type:"submit",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Send"})]}):null}function I(){return s.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[s.jsx("aside",{className:"w-1/3 border-r overflow-y-auto",children:s.jsx(_,{})}),s.jsxs("main",{className:"flex-1 flex flex-col",children:[s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(k,{})}),s.jsx(V,{})]})]})}export{I as default};
