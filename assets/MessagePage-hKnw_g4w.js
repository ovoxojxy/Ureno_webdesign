import{f as b,k as j,r as p,q as w,w as T,g as N,h,o as D,j as s,L as A,p as R,n as L,s as y,t as $,l as B}from"./index-BrTkbn2K.js";function F(){const{state:o,dispatch:r}=b(),{currentUser:t}=j();p.useEffect(()=>{if(!t){console.log("No current user found â€” exiting useEffect.");return}console.log("Current user UID:",t.uid);const e=w(N(h,"conversations"),T("participants","array-contains",t.uid)),i=D(e,n=>{console.log("onSnapshot triggered");const d=[];n.forEach(a=>{d.push({id:a.id,...a.data()})}),d.sort((a,u)=>{var S,x,C,E,f,M;const g=((C=(x=(S=a.lastMessage)==null?void 0:S.timestamp)==null?void 0:x.toMillis)==null?void 0:C.call(x))||0;return(((M=(f=(E=u.lastMessage)==null?void 0:E.timestamp)==null?void 0:f.toMillis)==null?void 0:M.call(f))||0)-g}),console.log("Fetched conversations:",d),r({type:"SET_CONVERSATIONS",payload:d})});return()=>i()},[t,r]),console.log("Conversations in state:",o.conversations);const l=e=>{console.log(`Selecting conversation: ${e}, current selection: ${o.selectedConversation}`),r({type:"SELECT_CONVERSATION",payload:e})},c=o.conversations,m=o.selectedConversation&&!c.some(e=>e.id===o.selectedConversation)?{id:o.selectedConversation,projectId:"Selected Conversation"}:null;return console.log("Selected conversation:",o.selectedConversation),console.log("Visible conversations:",c.map(e=>e.id)),s.jsxs("div",{className:"conversation-list",children:[s.jsxs("div",{className:"flex items-center gap-3 ",children:[s.jsx(A,{to:"/ProfileDashboard",className:"text-blue-500 text-3xl font-bold hover:scale-110 hover:text-blue-700 transition-all duration-200 flex items-center justify-center",children:"<"}),s.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"})]}),c.length===0&&!m?s.jsx("p",{children:"No conversations yet."}):s.jsxs("ul",{className:"space-y-4",children:[c.map(e=>{var i;return s.jsxs("li",{onClick:()=>l(e.id),className:`cursor-pointer p-3 rounded-md ${o.selectedConversation===e.id?"bg-blue-100 border-2 border-blue-500":"bg-gray-100"}`,children:[s.jsxs("div",{className:"font-semibold",children:["Project: ",e.projectId]}),s.jsx("div",{className:"text-sm text-gray-600",children:(i=e.lastMessage)!=null&&i.text?`${e.lastMessage.text.slice(0,30)}...`:"No messages yet"})]},e.id)}),m&&s.jsxs("li",{onClick:()=>l(m.id),className:"cursor-pointer p-3 rounded-md bg-blue-100 border-2 border-blue-500",children:[s.jsxs("div",{className:"font-semibold",children:["Project: ",m.projectId]}),s.jsx("div",{className:"text-sm text-gray-600",children:"Currently selected conversation"})]},m.id)]})]})}function _(){const{state:o,dispatch:r}=b(),{currentUser:t}=j(),{selectedConversation:l}=o,c=p.useRef(null),m=()=>{var e;(e=c.current)==null||e.scrollIntoView({behavior:"smooth"})};return p.useEffect(()=>{m()},[o.messages]),p.useEffect(()=>{if(!l)return;console.log("Loading messages for conversation:",l),console.log("Current user UID:",t==null?void 0:t.uid);const e=N(h,"conversations",l,"messages"),i=w(e,R("timestamp","asc")),n=D(i,d=>{const a=d.docs.map(u=>({id:u.id,...u.data()}));console.log("Fetched messages:",a),r({type:"SET_MESSAGES",payload:a})});return()=>n()},[l,r,t==null?void 0:t.uid]),l?(console.log("Rendering messages with currentUser:",t==null?void 0:t.uid),s.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[70vh]",children:[o.messages.length===0?s.jsx("div",{className:"text-center text-gray-500",children:"No messages in this conversation yet"}):[...o.messages].sort((e,i)=>{var a,u,g,v;const n=((u=(a=e.timestamp)==null?void 0:a.toMillis)==null?void 0:u.call(a))||(e.timestamp instanceof Date?e.timestamp.getTime():0),d=((v=(g=i.timestamp)==null?void 0:g.toMillis)==null?void 0:v.call(g))||(i.timestamp instanceof Date?i.timestamp.getTime():0);return n-d}).map(e=>{var n,d,a;const i=e.senderId===(t==null?void 0:t.uid);return s.jsx("div",{className:`flex ${i?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`p-2 rounded-md max-w-xs ${i?"bg-blue-500 text-white":"bg-gray-200"}`,children:[s.jsx("div",{className:"text-sm",children:e.text}),s.jsx("div",{className:`text-xs ${i?"text-blue-100":"text-gray-500"} text-right`,children:e.timestamp instanceof Date?e.timestamp.toLocaleString():((a=(d=(n=e.timestamp)==null?void 0:n.toDate)==null?void 0:d.call(n))==null?void 0:a.toLocaleString())||""})]})},e.id)}),s.jsx("div",{ref:c})]})):s.jsx("div",{className:"p-4",children:"No Conversation Selected"})}async function k(o,r,t,l=null){if(!o||!r||!t){console.error("Missing required parameters for sendMessage");return}try{const c=N(h,"conversations",o,"messages");await L(c,{senderId:r,text:t,timestamp:y()});const m={text:t,senderId:r,timestamp:y()},e={text:t,senderId:r,timestamp:new Date};return await $(B(h,"conversations",o),{lastMessage:m,updatedAt:y()}),l&&(l({type:"ADD_MESSAGE",payload:{id:Date.now().toString(),senderId:r,text:t,timestamp:new Date}}),l({type:"UPDATE_LAST_MESSAGE",payload:{conversationId:o,lastMessage:e}})),!0}catch(c){return console.error("Error sending message:",c),!1}}function q(){const[o,r]=p.useState(""),t=p.useRef(null),{state:l,dispatch:c}=b(),{currentUser:m}=j(),{selectedConversation:e}=l,i=async n=>{var a;if(n.preventDefault(),!o.trim())return;const d=o.trim();r("");try{await k(e,m.uid,d,c)?console.log("Message sent successfully"):console.error("Failed to send message"),(a=t.current)==null||a.focus()}catch(u){console.error("Error sending message:",u)}};return e?s.jsxs("form",{onSubmit:i,className:"flex items-center p-4 border-t",children:[s.jsx("input",{ref:t,type:"text",placeholder:"Type a message...",value:o,onChange:n=>r(n.target.value),className:"flex-1 p-2 border rounded-md",onKeyDown:n=>{n.key==="Escape"&&(r(""),n.target.blur())}}),s.jsx("button",{type:"submit",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Send"})]}):null}function V(){return s.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[s.jsx("aside",{className:"w-1/3 border-r overflow-y-auto",children:s.jsx(F,{})}),s.jsxs("main",{className:"flex-1 flex flex-col",children:[s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(_,{})}),s.jsx(q,{})]})]})}export{V as default};
