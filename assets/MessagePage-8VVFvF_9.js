import{b as U,h as T,r as g,U as L,q as I,w as $,e as R,f as N,o as A,j as e,L as B,i as E,n as P,p as O,t as k,s as D,m as _}from"./index-B1h-MAse.js";function q(){const{state:t,dispatch:f}=U(),{currentUser:r}=T(),{profile:i}=g.useContext(L),[h,S]=g.useState({}),w=(i==null?void 0:i.role)==="contractor"?"/contractor-dashboard":"/ProfileDashboard";g.useEffect(()=>{S({})},[r]),g.useEffect(()=>{if(!t.conversations||t.conversations.length===0)return;(async()=>{const y={},C=t.conversations.map(async s=>{if(!(!s.projectId||h[s.projectId]))try{const o=E(N,"projects",s.projectId),a=await P(o);if(a.exists()){const m=a.data();y[s.projectId]=m.title||"Untitled Project"}else y[s.projectId]="Unknown Project"}catch(o){console.error(`Error fetching project ${s.projectId}:`,o),y[s.projectId]="Error Loading Project"}});await Promise.all(C),S(s=>({...s,...y}))})()},[t.conversations,h]),g.useEffect(()=>{if(!r){console.log("No current user found — exiting useEffect.");return}console.log("Current user UID:",r.uid);const n=I(R(N,"conversations"),$("participants","array-contains",r.uid)),y=A(n,C=>{console.log("onSnapshot triggered");const s=[];C.forEach(o=>{s.push({id:o.id,...o.data()})}),s.sort((o,a)=>{var x,l,c,p,b,M;const m=((c=(l=(x=o.lastMessage)==null?void 0:x.timestamp)==null?void 0:l.toMillis)==null?void 0:c.call(l))||0;return(((M=(b=(p=a.lastMessage)==null?void 0:p.timestamp)==null?void 0:b.toMillis)==null?void 0:M.call(b))||0)-m}),console.log("Fetched conversations:",s),f({type:"SET_CONVERSATIONS",payload:s})});return()=>y()},[r,f]),console.log("Conversations in state:",t.conversations);const d=n=>{console.log(`Selecting conversation: ${n}, current selection: ${t.selectedConversation}`),f({type:"SELECT_CONVERSATION",payload:n})},j=t.conversations,v=t.selectedConversation&&!j.some(n=>n.id===t.selectedConversation)?{id:t.selectedConversation,projectId:"Selected Conversation"}:null;return console.log("Selected conversation:",t.selectedConversation),console.log("Visible conversations:",j.map(n=>n.id)),e.jsxs("div",{className:"conversation-list",children:[e.jsxs("div",{className:"flex items-center gap-3 ",children:[e.jsx(B,{to:w,className:"text-blue-500 text-3xl font-bold hover:scale-110 hover:text-blue-700 transition-all duration-200 flex items-center justify-center",children:"<"}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"})]}),j.length===0&&!v?e.jsx("p",{children:"No conversations yet."}):e.jsxs("ul",{className:"space-y-4",children:[j.map(n=>{var o,a,m,u,x,l,c;const y=((m=(a=(o=n.lastReadBy)==null?void 0:o[r.uid])==null?void 0:a.toMillis)==null?void 0:m.call(a))||0,s=(((l=(x=(u=n.lastMessage)==null?void 0:u.timestamp)==null?void 0:x.toMillis)==null?void 0:l.call(x))||0)>y;return e.jsxs("li",{onClick:()=>d(n.id),className:`cursor-pointer p-3 rounded-md ${t.selectedConversation===n.id?"bg-blue-100 border-2 border-blue-500":"bg-gray-100"} ${s?"font-bold text-blue-800":"text-gray-700"}`,children:[e.jsxs("div",{className:"font-semibold",children:["Project: ",n.projectTitle||h[n.projectId]||"Loading..."]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[(c=n.lastMessage)!=null&&c.text?`${n.lastMessage.text.slice(0,30)}...`:"No messages yet",s&&e.jsx("span",{className:"text-blue-500 ml-2",children:"•"})]})]},n.id)}),v&&e.jsxs("li",{onClick:()=>d(v.id),className:"cursor-pointer p-3 rounded-md bg-blue-100 border-2 border-blue-500",children:[e.jsxs("div",{className:"font-semibold",children:["Project: ",v.projectTitle||h[v.projectId]||"Loading..."]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Currently selected conversation"})]},v.id)]})]})}function F(){var C;const{state:t,dispatch:f}=U(),{currentUser:r}=T(),{selectedConversation:i}=t,h=g.useRef(null),[S,w]=g.useState({}),[d,j]=g.useState(null),[v,n]=g.useState(null),y=()=>{var s;(s=h.current)==null||s.scrollIntoView({behavior:"smooth"})};return g.useEffect(()=>{y()},[t.messages]),g.useEffect(()=>{if(!i||!t.currentConversationData)return;(async()=>{try{const o=t.currentConversationData.projectId;if(!o){console.warn("No project ID in conversation data");return}const a=E(N,"projects",o),m=await P(a);m.exists()?n({id:m.id,...m.data()}):(console.warn("Project not found:",o),n({title:"Unknown Project"}))}catch(o){console.error("Error fetching project information:",o),n({title:"Error Loading Project"})}})()},[i,t.currentConversationData]),g.useEffect(()=>{if(!i)return;(async()=>{try{if(!(r!=null&&r.uid)||!i)return;const u=E(N,"conversations",i),x=await P(u);if(!x.exists()){console.warn("Conversation document not found.");return}const l=x.data(),c=(l==null?void 0:l.participants)||[];if(!Array.isArray(c)||c.length!==2){console.warn("Unexpected participants format:",c);return}await k(E(N,"conversations",i),{[`lastReadBy.${r.uid}`]:D()});const p=c.find(M=>M!==r.uid);if(!p)return;const b=await P(E(N,"users",p));b.exists()&&j(b.data())}catch(u){console.error("Error fetching other participant info:",u)}})();const o=R(N,"conversations",i,"messages"),a=I(o,O("timestamp","asc")),m=A(a,async u=>{const x=u.docs.map(p=>({id:p.id,...p.data()}));f({type:"SET_MESSAGES",payload:x});const l=[...new Set(x.map(p=>p.senderId))],c={...S};for(const p of l)if(p&&!c[p])try{const b=await P(E(N,"users",p));if(b.exists()){const M=b.data();c[p]=M}else c[p]={firstName:"Unknown",role:"User"}}catch{c[p]={firstName:"Unknown",role:"User"}}w(c)});return()=>m()},[i,f,r==null?void 0:r.uid]),i?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"bg-gray-100 p-3 border-b sticky top-0",children:[e.jsx("h2",{className:"font-semibold text-lg",children:(v==null?void 0:v.title)||((C=t.currentConversationData)==null?void 0:C.projectId)||"Conversation"}),d&&e.jsxs("p",{className:"text-sm text-gray-600",children:["Chatting with: ",d.firstName||d.displayName||"User"," (",d.role||"User",")"]})]}),e.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto flex-grow",children:[t.messages.length===0?e.jsx("div",{className:"text-center text-gray-500",children:"No messages in this conversation yet"}):[...t.messages].sort((s,o)=>{var u,x,l,c;const a=((x=(u=s.timestamp)==null?void 0:u.toMillis)==null?void 0:x.call(u))||(s.timestamp instanceof Date?s.timestamp.getTime():0),m=((c=(l=o.timestamp)==null?void 0:l.toMillis)==null?void 0:c.call(l))||(o.timestamp instanceof Date?o.timestamp.getTime():0);return a-m}).map(s=>{var a,m,u;const o=s.senderId===(r==null?void 0:r.uid);return e.jsxs("div",{className:`flex flex-col ${o?"items-end":"items-start"}`,children:[!o&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("img",{src:(d==null?void 0:d.photoURL)||"/src/assets/images/default_pfp.png",alt:"sender",className:"w-6 h-6 rounded-full"}),e.jsx("div",{className:"text-xs text-gray-500",children:!o&&d?`${d.firstName||d.displayName||d.name||"Unknown"} • ${d.role||"User"}`:"Unknown sender • User"})]}),e.jsxs("div",{className:`p-2 rounded-md max-w-xs ${o?"bg-blue-500 text-white":"bg-gray-200"}`,children:[e.jsx("div",{className:"text-sm",children:s.text}),e.jsx("div",{className:`text-xs ${o?"text-blue-100":"text-gray-500"} text-right`,children:s.timestamp instanceof Date?s.timestamp.toLocaleString():((u=(m=(a=s.timestamp)==null?void 0:a.toDate)==null?void 0:m.call(a))==null?void 0:u.toLocaleString())||""})]})]},s.id)}),e.jsx("div",{ref:h})]})]}):e.jsx("div",{className:"p-4",children:"No Conversation Selected"})}async function V(t,f,r,i=null){if(!t||!f||!r){console.error("Missing required parameters for sendMessage");return}try{const h=R(N,"conversations",t,"messages");await _(h,{senderId:f,text:r,timestamp:D()});const S={text:r,senderId:f,timestamp:D()},w={text:r,senderId:f,timestamp:new Date};return await k(E(N,"conversations",t),{lastMessage:S,updatedAt:D()}),i&&(i({type:"ADD_MESSAGE",payload:{id:Date.now().toString(),senderId:f,text:r,timestamp:new Date}}),i({type:"UPDATE_LAST_MESSAGE",payload:{conversationId:t,lastMessage:w}})),!0}catch(h){return console.error("Error sending message:",h),!1}}function G(){const[t,f]=g.useState(""),r=g.useRef(null),{state:i,dispatch:h}=U(),{currentUser:S}=T(),{selectedConversation:w}=i,d=async j=>{var n;if(j.preventDefault(),!t.trim())return;const v=t.trim();f("");try{await V(w,S.uid,v,h)?console.log("Message sent successfully"):console.error("Failed to send message"),(n=r.current)==null||n.focus()}catch(y){console.error("Error sending message:",y)}};return w?e.jsxs("form",{onSubmit:d,className:"flex items-center p-4 border-t",children:[e.jsx("input",{ref:r,type:"text",placeholder:"Type a message...",value:t,onChange:j=>f(j.target.value),className:"flex-1 p-2 border rounded-md",onKeyDown:j=>{j.key==="Escape"&&(f(""),j.target.blur())}}),e.jsx("button",{type:"submit",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Send"})]}):null}function z(){return e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[e.jsx("aside",{className:"w-1/3 border-r overflow-y-auto",children:e.jsx(q,{})}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(F,{})}),e.jsx(G,{})]})]})}export{z as default};
