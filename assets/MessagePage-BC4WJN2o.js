import{b as k,h as T,r as x,U as F,q as I,w as O,e as A,f as N,o as B,j as e,L as V,i as M,n as U,p as G,t as _,s as D,m as z}from"./index-DbzBrB5S.js";function K(){const{state:a,dispatch:u}=k(),{currentUser:r}=T(),{profile:l}=x.useContext(F),[p,v]=x.useState({}),[g,m]=x.useState({}),b=(l==null?void 0:l.role)==="contractor"?"/contractor-dashboard":"/ProfileDashboard";x.useEffect(()=>{v({})},[r]),x.useEffect(()=>{if(!a.conversations||a.conversations.length===0)return;(async()=>{const i={},h=a.conversations.map(async n=>{var d;const t=(d=n.participants)==null?void 0:d.find(c=>c!==r.uid);if(!(!t||g[t]))try{const c=M(N,"users",t),f=await U(c);if(f.exists()){const o=f.data();i[t]=o.displayName||`${o.firstName||"Unkown"} ${o.lastName||""}`.trim()}else i[t]="Unkown User"}catch(c){console.error(`Error fetching user ${t}:`,c),i[t]="Error Loading User"}});await Promise.all(h),m(n=>({...n,...i}))})()},[a.conversations,g]),x.useEffect(()=>{if(!a.conversations||a.conversations.length===0)return;(async()=>{const i={},h=a.conversations.map(async n=>{if(!(!n.projectId||p[n.projectId]))try{const t=M(N,"projects",n.projectId),d=await U(t);if(d.exists()){const c=d.data();i[n.projectId]={title:c.title||"Untitled Project",status:c.status||"Unknown Status"}}else i[n.projectId]="Unknown Project"}catch(t){console.error(`Error fetching project ${n.projectId}:`,t),i[n.projectId]="Error Loading Project"}});await Promise.all(h),v(n=>({...n,...i}))})()},[a.conversations,p]),x.useEffect(()=>{if(!r){console.log("No current user found — exiting useEffect.");return}console.log("Current user UID:",r.uid);const s=I(A(N,"conversations"),O("participants","array-contains",r.uid)),i=B(s,h=>{console.log("onSnapshot triggered");const n=[];h.forEach(t=>{n.push({id:t.id,...t.data()})}),n.sort((t,d)=>{var o,j,S,P,E,R;const c=((S=(j=(o=t.lastMessage)==null?void 0:o.timestamp)==null?void 0:j.toMillis)==null?void 0:S.call(j))||0;return(((R=(E=(P=d.lastMessage)==null?void 0:P.timestamp)==null?void 0:E.toMillis)==null?void 0:R.call(E))||0)-c}),console.log("Fetched conversations:",n),u({type:"SET_CONVERSATIONS",payload:n})});return()=>i()},[r,u]);const C=s=>{console.log(`Selecting conversation: ${s}, current selection: ${a.selectedConversation}`),u({type:"SELECT_CONVERSATION",payload:s})},w=a.conversations,y=a.selectedConversation&&!w.some(s=>s.id===a.selectedConversation)?{id:a.selectedConversation,projectId:"Selected Conversation"}:null;return e.jsxs("div",{className:"conversation-list",children:[e.jsxs("div",{className:"flex items-center gap-3 ",children:[e.jsx(V,{to:b,className:"text-blue-500 text-3xl font-bold hover:scale-110 hover:text-blue-700 transition-all duration-200 flex items-center justify-center",children:"<"}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"})]}),w.length===0&&!y?e.jsx("p",{children:"No conversations yet."}):e.jsxs("ul",{className:"space-y-4",children:[w.map(s=>{var t,d,c,f,o,j,S,P,E,R,$,L;const i=((c=(d=(t=s.lastReadBy)==null?void 0:t[r.uid])==null?void 0:d.toMillis)==null?void 0:c.call(d))||0,n=(((j=(o=(f=s.lastMessage)==null?void 0:f.timestamp)==null?void 0:o.toMillis)==null?void 0:j.call(o))||0)>i;return e.jsxs("li",{onClick:()=>C(s.id),className:`cursor-pointer p-3 rounded-md ${a.selectedConversation===s.id?"bg-blue-100 border-2 border-blue-500":"bg-gray-100"} ${n?"font-bold text-blue-800":"text-gray-700"}`,children:[e.jsx("div",{className:"font-medium text-gray-800",children:g[(S=s.participants)==null?void 0:S.find(q=>q!==r.uid)]||"loading..."}),e.jsxs("div",{children:["Project: ",s.projectTitle||((P=p[s.projectId])==null?void 0:P.title)||"Loading...",e.jsx("span",{className:`ml-2 text-xs px-2 py-1 rounded-full ${((R=(E=p[s.projectId])==null?void 0:E.status)==null?void 0:R.toLowerCase())==="in progress"?"bg-green-200 text-green-800":"bg-yellow-200 text-yellow-800"}`,children:(($=p[s.projectId])==null?void 0:$.status)||"Unknown Status"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[(L=s.lastMessage)!=null&&L.text?`${s.lastMessage.text.slice(0,30)}...`:"No messages yet",n&&e.jsx("span",{className:"text-blue-500 ml-2",children:"•"})]})]},s.id)}),y&&e.jsxs("li",{onClick:()=>C(y.id),className:"cursor-pointer p-3 rounded-md bg-blue-100 border-2 border-blue-500",children:[e.jsxs("div",{className:"font-semibold",children:["Project: ",y.projectTitle||p[y.projectId]||"Loading..."]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Currently selected conversation"})]},y.id)]})]})}function H({userId:a,isOpen:u,onClose:r}){const[l,p]=x.useState(null);return x.useEffect(()=>{if(!a||!u)return;(async()=>{try{const g=M(N,"users",a),m=await U(g);m.exists()?p(m.data()):p({displayName:"Unknown",role:"N/A"})}catch(g){console.error("Failed to fetch user: ",g)}})()},[a,u]),u?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg w-96",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"User Profile"}),l?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",l.displayName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Role:"})," ",l.role]})]}):e.jsx("p",{children:"Loading..."}),e.jsx("button",{onClick:r,className:"mt-4 bg-blue-500 text-white px-4 py-2 rounded",children:"Close"})]})}):null}function J(){const{state:a,dispatch:u}=k(),{currentUser:r}=T(),{selectedConversation:l}=a,p=x.useRef(null),[v,g]=x.useState({}),[m,b]=x.useState(null),[C,w]=x.useState(!1),y=()=>{var s;(s=p.current)==null||s.scrollIntoView({behavior:"smooth"})};return x.useEffect(()=>{y()},[a.messages]),x.useEffect(()=>{if(!l)return;(async()=>{try{if(!(r!=null&&r.uid)||!l)return;const t=M(N,"conversations",l),d=await U(t);if(!d.exists()){console.warn("Conversation document not found.");return}const c=d.data(),f=(c==null?void 0:c.participants)||[];if(!Array.isArray(f)||f.length!==2){console.warn("Unexpected participants format:",f);return}await _(M(N,"conversations",l),{[`lastReadBy.${r.uid}`]:D()});const o=f.find(S=>S!==r.uid);if(!o)return;const j=await U(M(N,"users",o));j.exists()&&b(j.data())}catch(t){console.error("Error fetching other participant info:",t)}})();const i=A(N,"conversations",l,"messages"),h=I(i,G("timestamp","asc")),n=B(h,async t=>{const d=t.docs.map(o=>({id:o.id,...o.data()}));u({type:"SET_MESSAGES",payload:d});const c=[...new Set(d.map(o=>o.senderId))],f={...v};for(const o of c)if(o&&!f[o])try{const j=await U(M(N,"users",o));if(j.exists()){const S=j.data();f[o]=S}else f[o]={firstName:"Unknown",role:"User"}}catch{f[o]={firstName:"Unknown",role:"User"}}g(f)});return()=>n()},[l,u,r==null?void 0:r.uid]),l?e.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[70vh]",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h2",{className:"text-lg font-bold",children:["Chat with ",(m==null?void 0:m.displayName)||"Loading..."]}),e.jsx("button",{onClick:()=>w(!0),className:"text-blue-500 hover:underline",children:"View Profile"})]}),m&&e.jsx(H,{userId:m.uid,isOpen:C,onClose:()=>w(!1)}),a.messages.length===0?e.jsx("div",{className:"text-center text-gray-500",children:"No messages in this conversation yet"}):[...a.messages].sort((s,i)=>{var t,d,c,f;const h=((d=(t=s.timestamp)==null?void 0:t.toMillis)==null?void 0:d.call(t))||(s.timestamp instanceof Date?s.timestamp.getTime():0),n=((f=(c=i.timestamp)==null?void 0:c.toMillis)==null?void 0:f.call(c))||(i.timestamp instanceof Date?i.timestamp.getTime():0);return h-n}).map(s=>{var h,n,t;const i=s.senderId===(r==null?void 0:r.uid);return e.jsxs("div",{className:`flex flex-col ${i?"items-end":"items-start"}`,children:[!i&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("img",{src:(m==null?void 0:m.photoURL)||"/src/assets/images/default_pfp.png",alt:"sender",className:"w-6 h-6 rounded-full"}),e.jsx("div",{className:"text-xs text-gray-500",children:!i&&m?`${m.firstName||m.displayName||m.name||"Unknown"} • ${m.role||"User"}`:"Unknown sender • User"})]}),e.jsxs("div",{className:`p-2 rounded-md max-w-xs ${i?"bg-blue-500 text-white":"bg-gray-200"}`,children:[e.jsx("div",{className:"text-sm",children:s.text}),e.jsx("div",{className:`text-xs ${i?"text-blue-100":"text-gray-500"} text-right`,children:s.timestamp instanceof Date?s.timestamp.toLocaleString():((t=(n=(h=s.timestamp)==null?void 0:h.toDate)==null?void 0:n.call(h))==null?void 0:t.toLocaleString())||""})]})]},s.id)}),e.jsx("div",{ref:p})]}):e.jsx("div",{className:"p-4",children:"No Conversation Selected"})}async function Q(a,u,r,l=null){if(!a||!u||!r){console.error("Missing required parameters for sendMessage");return}try{const p=A(N,"conversations",a,"messages");await z(p,{senderId:u,text:r,timestamp:D()});const v={text:r,senderId:u,timestamp:D()},g={text:r,senderId:u,timestamp:new Date};return await _(M(N,"conversations",a),{lastMessage:v,updatedAt:D()}),l&&(l({type:"ADD_MESSAGE",payload:{id:Date.now().toString(),senderId:u,text:r,timestamp:new Date}}),l({type:"UPDATE_LAST_MESSAGE",payload:{conversationId:a,lastMessage:g}})),!0}catch(p){return console.error("Error sending message:",p),!1}}function W(){const[a,u]=x.useState(""),r=x.useRef(null),{state:l,dispatch:p}=k(),{currentUser:v}=T(),{selectedConversation:g}=l,m=async b=>{var w;if(b.preventDefault(),!a.trim())return;const C=a.trim();u("");try{await Q(g,v.uid,C,p)?console.log("Message sent successfully"):console.error("Failed to send message"),(w=r.current)==null||w.focus()}catch(y){console.error("Error sending message:",y)}};return g?e.jsxs("form",{onSubmit:m,className:"flex items-center p-4 border-t",children:[e.jsx("input",{ref:r,type:"text",placeholder:"Type a message...",value:a,onChange:b=>u(b.target.value),className:"flex-1 p-2 border rounded-md",onKeyDown:b=>{b.key==="Escape"&&(u(""),b.target.blur())}}),e.jsx("button",{type:"submit",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Send"})]}):null}function Y(){return e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[e.jsx("aside",{className:"w-1/3 border-r overflow-y-auto",children:e.jsx(K,{})}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(J,{})}),e.jsx(W,{})]})]})}export{Y as default};
