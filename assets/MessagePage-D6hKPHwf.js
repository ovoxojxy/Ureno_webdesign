import{b as E,h as D,r as y,U as P,q as R,w as k,e as U,f as N,o as T,j as e,L as B,n as L,p as C,i as w,t as $,s as M,m as O}from"./index-C3hwRcN-.js";function _(){const{state:a,dispatch:m}=E(),{currentUser:s}=D(),{profile:d}=y.useContext(P),h=(d==null?void 0:d.role)==="contractor"?"/contractor-dashboard":"/ProfileDashboard";y.useEffect(()=>{if(!s){console.log("No current user found — exiting useEffect.");return}console.log("Current user UID:",s.uid);const t=R(U(N,"conversations"),k("participants","array-contains",s.uid)),S=T(t,r=>{console.log("onSnapshot triggered");const n=[];r.forEach(p=>{n.push({id:p.id,...p.data()})}),n.sort((p,f)=>{var l,o,i,v,j,A;const c=((i=(o=(l=p.lastMessage)==null?void 0:l.timestamp)==null?void 0:o.toMillis)==null?void 0:i.call(o))||0;return(((A=(j=(v=f.lastMessage)==null?void 0:v.timestamp)==null?void 0:j.toMillis)==null?void 0:A.call(j))||0)-c}),console.log("Fetched conversations:",n),m({type:"SET_CONVERSATIONS",payload:n})});return()=>S()},[s,m]),console.log("Conversations in state:",a.conversations);const b=t=>{console.log(`Selecting conversation: ${t}, current selection: ${a.selectedConversation}`),m({type:"SELECT_CONVERSATION",payload:t})},g=a.conversations,u=a.selectedConversation&&!g.some(t=>t.id===a.selectedConversation)?{id:a.selectedConversation,projectId:"Selected Conversation"}:null;return console.log("Selected conversation:",a.selectedConversation),console.log("Visible conversations:",g.map(t=>t.id)),e.jsxs("div",{className:"conversation-list",children:[e.jsxs("div",{className:"flex items-center gap-3 ",children:[e.jsx(B,{to:h,className:"text-blue-500 text-3xl font-bold hover:scale-110 hover:text-blue-700 transition-all duration-200 flex items-center justify-center",children:"<"}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"})]}),g.length===0&&!u?e.jsx("p",{children:"No conversations yet."}):e.jsxs("ul",{className:"space-y-4",children:[g.map(t=>{var p,f,c,x,l,o,i;const S=((c=(f=(p=t.lastReadBy)==null?void 0:p[s.uid])==null?void 0:f.toMillis)==null?void 0:c.call(f))||0,n=(((o=(l=(x=t.lastMessage)==null?void 0:x.timestamp)==null?void 0:l.toMillis)==null?void 0:o.call(l))||0)>S;return e.jsxs("li",{onClick:()=>b(t.id),className:`cursor-pointer p-3 rounded-md ${a.selectedConversation===t.id?"bg-blue-100 border-2 border-blue-500":"bg-gray-100"} ${n?"font-bold text-blue-800":"text-gray-700"}`,children:[e.jsxs("div",{className:"font-semibold",children:["Project: ",t.projectId]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[(i=t.lastMessage)!=null&&i.text?`${t.lastMessage.text.slice(0,30)}...`:"No messages yet",n&&e.jsx("span",{className:"text-blue-500 ml-2",children:"•"})]})]},t.id)}),u&&e.jsxs("li",{onClick:()=>b(u.id),className:"cursor-pointer p-3 rounded-md bg-blue-100 border-2 border-blue-500",children:[e.jsxs("div",{className:"font-semibold",children:["Project: ",u.projectId]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Currently selected conversation"})]},u.id)]})]})}function q(){const{state:a,dispatch:m}=E(),{currentUser:s}=D(),{selectedConversation:d}=a,h=y.useRef(null),[b,g]=y.useState({}),[u,t]=y.useState(null),S=()=>{var r;(r=h.current)==null||r.scrollIntoView({behavior:"smooth"})};return y.useEffect(()=>{S()},[a.messages]),y.useEffect(()=>{if(!d)return;(async()=>{try{if(!(s!=null&&s.uid)||!d)return;const c=w(N,"conversations",d),x=await C(c);if(!x.exists()){console.warn("Conversation document not found.");return}const l=x.data(),o=(l==null?void 0:l.participants)||[];if(!Array.isArray(o)||o.length!==2){console.warn("Unexpected participants format:",o);return}await $(w(N,"conversations",d),{[`lastReadBy.${s.uid}`]:M()});const i=o.find(j=>j!==s.uid);if(!i)return;const v=await C(w(N,"users",i));v.exists()&&t(v.data())}catch(c){console.error("Error fetching other participant info:",c)}})();const n=U(N,"conversations",d,"messages"),p=R(n,L("timestamp","asc")),f=T(p,async c=>{const x=c.docs.map(i=>({id:i.id,...i.data()}));m({type:"SET_MESSAGES",payload:x});const l=[...new Set(x.map(i=>i.senderId))],o={...b};for(const i of l)if(i&&!o[i])try{const v=await C(w(N,"users",i));if(v.exists()){const j=v.data();o[i]=j}else o[i]={firstName:"Unknown",role:"User"}}catch{o[i]={firstName:"Unknown",role:"User"}}g(o)});return()=>f()},[d,m,s==null?void 0:s.uid]),d?e.jsxs("div",{className:"p-4 space-y-3 overflow-y-auto max-h-[70vh]",children:[a.messages.length===0?e.jsx("div",{className:"text-center text-gray-500",children:"No messages in this conversation yet"}):[...a.messages].sort((r,n)=>{var c,x,l,o;const p=((x=(c=r.timestamp)==null?void 0:c.toMillis)==null?void 0:x.call(c))||(r.timestamp instanceof Date?r.timestamp.getTime():0),f=((o=(l=n.timestamp)==null?void 0:l.toMillis)==null?void 0:o.call(l))||(n.timestamp instanceof Date?n.timestamp.getTime():0);return p-f}).map(r=>{var p,f,c;const n=r.senderId===(s==null?void 0:s.uid);return e.jsxs("div",{className:`flex flex-col ${n?"items-end":"items-start"}`,children:[!n&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("img",{src:(u==null?void 0:u.photoURL)||"/src/assets/images/default_pfp.png",alt:"sender",className:"w-6 h-6 rounded-full"}),e.jsx("div",{className:"text-xs text-gray-500",children:!n&&u?`${u.firstName||u.displayName||u.name||"Unknown"} • ${u.role||"User"}`:"Unknown sender • User"})]}),e.jsxs("div",{className:`p-2 rounded-md max-w-xs ${n?"bg-blue-500 text-white":"bg-gray-200"}`,children:[e.jsx("div",{className:"text-sm",children:r.text}),e.jsx("div",{className:`text-xs ${n?"text-blue-100":"text-gray-500"} text-right`,children:r.timestamp instanceof Date?r.timestamp.toLocaleString():((c=(f=(p=r.timestamp)==null?void 0:p.toDate)==null?void 0:f.call(p))==null?void 0:c.toLocaleString())||""})]})]},r.id)}),e.jsx("div",{ref:h})]}):e.jsx("div",{className:"p-4",children:"No Conversation Selected"})}async function F(a,m,s,d=null){if(!a||!m||!s){console.error("Missing required parameters for sendMessage");return}try{const h=U(N,"conversations",a,"messages");await O(h,{senderId:m,text:s,timestamp:M()});const b={text:s,senderId:m,timestamp:M()},g={text:s,senderId:m,timestamp:new Date};return await $(w(N,"conversations",a),{lastMessage:b,updatedAt:M()}),d&&(d({type:"ADD_MESSAGE",payload:{id:Date.now().toString(),senderId:m,text:s,timestamp:new Date}}),d({type:"UPDATE_LAST_MESSAGE",payload:{conversationId:a,lastMessage:g}})),!0}catch(h){return console.error("Error sending message:",h),!1}}function V(){const[a,m]=y.useState(""),s=y.useRef(null),{state:d,dispatch:h}=E(),{currentUser:b}=D(),{selectedConversation:g}=d,u=async t=>{var r;if(t.preventDefault(),!a.trim())return;const S=a.trim();m("");try{await F(g,b.uid,S,h)?console.log("Message sent successfully"):console.error("Failed to send message"),(r=s.current)==null||r.focus()}catch(n){console.error("Error sending message:",n)}};return g?e.jsxs("form",{onSubmit:u,className:"flex items-center p-4 border-t",children:[e.jsx("input",{ref:s,type:"text",placeholder:"Type a message...",value:a,onChange:t=>m(t.target.value),className:"flex-1 p-2 border rounded-md",onKeyDown:t=>{t.key==="Escape"&&(m(""),t.target.blur())}}),e.jsx("button",{type:"submit",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Send"})]}):null}function G(){return e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[e.jsx("aside",{className:"w-1/3 border-r overflow-y-auto",children:e.jsx(_,{})}),e.jsxs("main",{className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx(q,{})}),e.jsx(V,{})]})]})}export{G as default};
